<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1>Welcome to Codenames!</h1>
    <h2 id="h2ClientId">You haven't connected to server</h2>
    <h2 id="h2GameId">You haven't joined a game</h2>
    <button id='btnCreate'>Create Game</button>
    <br />
    <input id='txtGameId' type='text' />
    <button id='btnJoin'>Join Game</button>
    <br />
    <button id='btnLeave' style='visibility: hidden;'>Leave Game</button>
    <button id='btnShowHideMap' style='visibility: hidden;'>Show/Hide Map</button>
    <button id='btnRestart' style='visibility: hidden;'>Restart Game</button>
    <h2>Players in the room:</h2>
    <div id='divPlayers'></div>
    <h2>Cards:</h2>
    <div id='divCards' style='display: grid; grid-template-columns: 150px 150px 150px 150px 150px;'></div>

    <script>
        let clientId = null;
        let gameId = null;
        let showMap = false;
        // let game = null; // TODO: now no game state locally. performance issue? set only when join?
        const h2ClientId = document.getElementById('h2ClientId');
        const h2GameId = document.getElementById('h2GameId');
        const btnCreate = document.getElementById('btnCreate');
        const txtGameId = document.getElementById('txtGameId');
        const btnJoin = document.getElementById('btnJoin');
        const btnLeave = document.getElementById('btnLeave');
        const btnShowHideMap = document.getElementById('btnShowHideMap');
        const btnRestart = document.getElementById('btnRestart');
        const divPlayers = document.getElementById('divPlayers');
        const divCards = document.getElementById('divCards');

        // make requests to server
        btnCreate.addEventListener('click', e => {
            const payload = {
                'method': 'create',
                'clientId': clientId
            };
            ws.send(JSON.stringify(payload));
        });

        btnJoin.addEventListener('click', e => {
            gameId = txtGameId.value
            const payload = {
                'method': 'join',
                'clientId': clientId,
                'gameId': gameId
            };
            ws.send(JSON.stringify(payload));
        });

        btnLeave.addEventListener('click', e => {
            gameId = txtGameId.value
            const payload = {
                'method': 'leave',
                'clientId': clientId,
                'gameId': gameId
            };
            ws.send(JSON.stringify(payload));
        });

        btnRestart.addEventListener('click', e => {
            showMap = false;
            gameId = txtGameId.value
            const payload = {
                'method': 'restart',
                'clientId': clientId,
                'gameId': gameId
            };
            ws.send(JSON.stringify(payload));
        });

        btnShowHideMap.addEventListener('click', e => {
            showMap = !showMap;
        });

        window.addEventListener("beforeunload", () => {
            const payload = {
                'method': 'close',
                'clientId': clientId,
                'gameId': gameId
            }
            ws.send(JSON.stringify(payload))
        });

        // handle responses from server
        let ws = new WebSocket('ws://127.0.0.1:8080')
        ws.onmessage = (message) => {
            const response = JSON.parse(message.data);
            
            if (response.method === 'connect'){
                clientId = response.clientId
                h2ClientId.innerText = "Your ClientId is " + clientId
            };

            if (response.method === 'create'){
                txtGameId.value = response.gameId
            };

            if (response.method === 'join'){
                txtGameId.value = response.gameId;
                h2GameId.innerText = "Your GameId is " + response.gameId;
                btnCreate.style.visibility = "hidden";
                txtGameId.style.visibility = "hidden";
                btnJoin.style.visibility = "hidden";
                btnLeave.style.visibility = "visible";
                btnShowHideMap.style.visibility = "visible";
                btnRestart.style.visibility = "visible";
            };

            if (response.method === 'leave'){
                if (response.status === 'success'){
                    gameId = null;
                    h2GameId.innerText = "You haven't joined a game";
                    while (divPlayers.firstChild){
                        divPlayers.removeChild(divPlayers.firstChild);
                    }
                    while (divCards.firstChild){
                        divCards.removeChild(divCards.firstChild);
                    }
                    btnCreate.style.visibility = "visible";
                    txtGameId.style.visibility = "visible";
                    btnJoin.style.visibility = "visible";
                    btnLeave.style.visibility = "hidden";
                    btnShowHideMap.style.visibility = "hidden";
                    btnRestart.style.visibility = "hidden";
                }
            }

            if (response.method === 'update'){
                // update players in the room
                while (divPlayers.firstChild){
                    divPlayers.removeChild(divPlayers.firstChild);
                }
                response.game.clients.forEach(c => {
                    const div = document.createElement('div')
                    div.style.width = '200px';
                    div.style.background = 'green';
                    div.style.marginBottom = '10px';
                    div.textContent = c;
                    divPlayers.appendChild(div)
                })

                // update cards
                while (divCards.firstChild){
                    divCards.removeChild(divCards.firstChild);
                }
                response.game.cards.forEach((c,i) => {
                    const btn = document.createElement('button')
                    btn.id = "card_" + i;
                    btn.tag = i;
                    btn.style.height = '150px';
                    btn.style.width = '150px';
                    if (showMap) {
                        const colorMap = {
                            'red': 'lightcoral',
                            'blue': 'lightblue',
                            'yellow': 'lightyellow',
                            'grey': 'lightgrey',
                        }
                        btn.style.background = c.isClicked ? c.color : colorMap[c.color];
                    } else {
                        btn.style.background = c.isClicked ? c.color : 'white';
                    }
                    btn.textContent = c.word;
                    btn.addEventListener('click', e => {
                        btn.style.background = c.color;
                        const payload = {
                            'method': 'play',
                            'gameId': gameId,
                            'cardId': btn.tag
                        }
                        ws.send(JSON.stringify(payload))
                    })
                    divCards.appendChild(btn);
                })
            }
        }
    </script>
</body>
</html>